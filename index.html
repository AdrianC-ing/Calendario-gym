<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendario de Gym</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #334155;
      --accent: #22c55e;
      --text: #e5e7eb;
      --text-dim: #94a3b8;
      --card: #0b1220;
      --warn: #f59e0b;
    }
    html, body { height:100%; }
    body {
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(120deg, #0b1220, #0f172a);
      color: var(--text);
      display:flex; align-items:stretch; justify-content:center;
    }
    .container { display:grid; grid-template-columns: 320px 1fr; gap: 16px; width: min(1200px, 100%); padding: 16px; }

    .panel { background: var(--panel); border:1px solid #1f2937; border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .title { font-size: 22px; font-weight: 700; letter-spacing:.2px; }
    .muted { color: var(--text-dim); font-size: 13px; }

    .config label { display:block; margin: 14px 0 6px; font-weight:600; }
    .config input[type="text"], .config select { width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 10px; border:1px solid #233044; background:#0b1324; color: var(--text); }
    .row { display:flex; gap:8px; align-items:center; }
    .row>* { flex:1; }

    .dow { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top: 8px; }
    .dow-item { background:#0b1324; border:1px solid #233044; border-radius: 12px; padding:10px; }
    .dow-item h4 { margin:0 0 8px; font-size: 13px; color: var(--text-dim); font-weight:700; text-transform:uppercase; letter-spacing:.6px; }
    .dow-item input { width:100%; padding:8px 10px; border-radius:8px; border:1px solid #233044; background:#0b1428; color:var(--text); }
    .dow-item .check { display:flex; align-items:center; gap:8px; margin-top:8px; font-size:13px; color: var(--text-dim); }

    .btn { border:1px solid #1f2937; background:#0b1428; color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn:hover { filter: brightness(1.1); }
    .btn.accent { background: var(--accent); border-color: transparent; color:#052e16; }
    .btn.warn { background: var(--warn); color:#1f1300; border-color: transparent; }

    .calendar { display:grid; grid-template-rows: auto auto 1fr; gap: 12px; }
    .cal-header { display:flex; align-items:center; justify-content:space-between; }
    .cal-header h2 { margin:0; font-size: 24px; }
    .cal-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; }
    .dow-head { text-align:center; font-weight:700; color:var(--text-dim); font-size:12px; letter-spacing:.6px; }

    .day { background: var(--card); border: 1px solid #1e293b; border-radius: 12px; padding:10px; min-height: 110px; display:flex; flex-direction:column; gap:6px; position:relative; }
    .day .num { font-size: 12px; color: var(--text-dim); }
    .day .workout { font-size: 13px; line-height:1.3; }
    .day .done { position:absolute; top:8px; right:8px; font-size: 11px; background: #16a34a33; color:#86efac; padding:3px 6px; border-radius: 999px; border:1px solid #14532d; display:none; }
    .day.done .done { display:inline-block; }
    .day.rest { opacity:.6; }
    .legend { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .tag { font-size:12px; padding:6px 8px; border-radius:999px; background:#0b1428; border:1px solid #233044; color:var(--text-dim); }

    .day textarea { width:100%; min-height: 48px; resize: vertical; box-sizing:border-box; padding:8px; border-radius:8px; border:1px solid #233044; background:#0b1428; color:var(--text);
    }

    .footer { display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top: 8px; }

    @media (max-width: 980px) {
      .container { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <aside class="panel config">
      <div class="title">Tu rutina semanal</div>
      <p class="muted">Edita qué entrenas cada día. Se aplicará al calendario del mes visible. Se guarda automáticamente en este navegador.</p>

      <div class="dow">
        <!-- Se crea dinámicamente con JS -->
      </div>

      <label style="margin-top:16px">Duración por sesión (minutos)</label>
      <input id="duracion" type="number" min="10" max="240" value="60" />

      <div class="footer">
        <button id="savePlan" class="btn accent">Guardar rutina</button>
        <button id="resetMonth" class="btn warn">Reset mes</button>
      </div>

      <div style="height:12px"></div>
      <button id="exportICS" class="btn" style="width:100%">Exportar .ics (calendario)</button>
      <div style="height:8px"></div>
      <button id="exportData" class="btn" style="width:100%">Exportar datos (.json)</button>
      <div style="height:8px"></div>
      <label for="importData" class="btn" style="width:100%; display:inline-block; text-align:center; cursor:pointer;">Importar datos (.json)</label>
      <input id="importData" type="file" accept="application/json" style="display:none" />
      <p class="muted" style="margin-top:8px">El .ics crea eventos de día completo con el nombre del entrenamiento para los días configurados como "Voy".</p>

      <hr style="border:none;border-top:1px solid #233044;margin:16px 0">
      <div class="title" style="font-size:18px">Sincronización (opcional)</div>
      <p class="muted">Para usar los mismos datos en varios dispositivos sin exportar/importar, puedes sincronizar con <strong>GitHub Gist</strong> usando un token personal <em>(scope: gist)</em>. El token se guarda <u>solo</u> en este navegador.</p>
      <label>GitHub Token (scope: gist)</label>
      <input id="gistToken" type="text" placeholder="ghp_..." />
      <label>Gist ID (si ya tienes uno)</label>
      <input id="gistId" type="text" placeholder="ej. a1b2c3d4..." />
      <div class="row">
        <button id="createGist" class="btn">Crear Gist privado</button>
        <button id="gistUpload" class="btn">Subir a Gist</button>
        <button id="gistDownload" class="btn">Bajar de Gist</button>
      </div>
      <p class="muted">Seguridad: no compartas tu token. Si pierdes el dispositivo, revoca el token en GitHub Settings → Developer settings → Personal access tokens.</p>
    </aside>

    <main class="panel calendar">
      <div class="cal-header">
        <button id="prev" class="btn">◀</button>
        <h2 id="monthLabel">Marzo 2025</h2>
        <button id="next" class="btn">▶</button>
      </div>
      <div class="cal-grid" id="dowHead"></div>
      <div class="cal-grid" id="days"></div>
      <div class="legend">
        <span class="tag">Clic en un día: marcar hecho / añadir notas</span>
        <span class="tag">Verde = día hecho</span>
        <span class="tag">Gris = descanso</span>
      </div>
    </main>
  </div>

  <script>
    const DOW = ["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"];
    const STORAGE_KEYS = {
      plan: 'gym.plan.v1', // rutina por día de semana
      monthDataPrefix: 'gym.month.' // + YYYY-MM
    };

    const defaultPlan = {
      "Lunes":    { go: true,  workout: "Pecho + Tríceps" },
      "Martes":   { go: true,  workout: "Espalda + Bíceps" },
      "Miércoles":{ go: true,  workout: "Piernas" },
      "Jueves":   { go: true,  workout: "Hombros + Core" },
      "Viernes":  { go: true,  workout: "Full Body / HIIT" },
      "Sábado":   { go: false, workout: "Descanso / Movilidad" },
      "Domingo":  { go: false, workout: "Cardio suave / Paseo" }
    };

    const state = {
      current: new Date(), // referencia de mes
      plan: loadPlan(),
      duration: Number(localStorage.getItem('gym.duration') || 60),
    };

    const el = {
      monthLabel: document.getElementById('monthLabel'),
      days: document.getElementById('days'),
      dowHead: document.getElementById('dowHead'),
      dow: document.querySelector('.dow'),
      savePlan: document.getElementById('savePlan'),
      resetMonth: document.getElementById('resetMonth'),
      exportICS: document.getElementById('exportICS'),
      exportData: document.getElementById('exportData'),
      importData: document.getElementById('importData'),
      gistToken: document.getElementById('gistToken'),
      gistId: document.getElementById('gistId'),
      createGist: document.getElementById('createGist'),
      gistUpload: document.getElementById('gistUpload'),
      gistDownload: document.getElementById('gistDownload'),
      duracion: document.getElementById('duracion'),
      prev: document.getElementById('prev'),
      next: document.getElementById('next')
    };

    // Build UI
    function init() {
      // Set start of week to Monday visuals
      buildDowHead();
      buildDowConfig();
      el.duracion.value = state.duration;
      renderCalendar();

      el.prev.onclick = () => { shiftMonth(-1); };
      el.next.onclick = () => { shiftMonth(1); };
      el.savePlan.onclick = savePlan;
      el.resetMonth.onclick = () => { if(confirm('¿Seguro que quieres resetear este mes?')) { saveMonthData({}, true); renderCalendar(); }};
      el.exportICS.onclick = exportICS;
      el.exportData.onclick = exportData;
      el.importData.onchange = importData;
      el.duracion.onchange = () => { state.duration = Math.max(10, Math.min(240, Number(el.duracion.value||60))); localStorage.setItem('gym.duration', state.duration); };
      // Sync handlers
      el.gistToken.value = localStorage.getItem('gym.gist.token') || '';
      el.gistId.value = localStorage.getItem('gym.gist.id') || '';
      el.gistToken.onchange = () => localStorage.setItem('gym.gist.token', el.gistToken.value.trim());
      el.gistId.onchange = () => localStorage.setItem('gym.gist.id', el.gistId.value.trim());
      el.createGist.onclick = createGist;
      el.gistUpload.onclick = uploadToGist;
      el.gistDownload.onclick = downloadFromGist;
    }

    function monthKey(dt = state.current){
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      return `${y}-${m}`;
    }

    function loadPlan(){
      try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.plan)) || structuredClone(defaultPlan); } catch { return structuredClone(defaultPlan); }
    }

    function savePlan(){
      // read UI fields into plan
      const inputs = el.dow.querySelectorAll('[data-day]');
      inputs.forEach(box => {
        const day = box.dataset.day;
        const go = box.querySelector('input[type="checkbox"]').checked;
        const workout = box.querySelector('input[type="text"]').value.trim();
        state.plan[day] = { go, workout };
      });
      localStorage.setItem(STORAGE_KEYS.plan, JSON.stringify(state.plan));
      alert('Rutina guardada.');
      renderCalendar();
    }

    function getMonthData(){
      const key = STORAGE_KEYS.monthDataPrefix + monthKey();
      try { return JSON.parse(localStorage.getItem(key)) || {}; } catch { return {}; }
    }

    function saveMonthData(data, overwrite=false){
      const key = STORAGE_KEYS.monthDataPrefix + monthKey();
      const current = overwrite ? {} : getMonthData();
      const merged = { ...current, ...data };
      localStorage.setItem(key, JSON.stringify(merged));
    }

    function buildDowHead(){
      el.dowHead.innerHTML = '';
      const order = [1,2,3,4,5,6,0]; // Mon..Sun
      order.forEach(i => {
        const div = document.createElement('div');
        div.className = 'dow-head';
        div.textContent = new Intl.DateTimeFormat('es-ES', { weekday:'short' }).format(new Date(2025, 8, i+1));
        el.dowHead.appendChild(div);
      });
    }

    function buildDowConfig(){
      el.dow.innerHTML = '';
      DOW.forEach(day => {
        const wrap = document.createElement('div');
        wrap.className = 'dow-item';
        wrap.dataset.day = day;
        wrap.innerHTML = `
          <h4>${day}</h4>
          <input type="text" placeholder="Ej. Piernas / Cardio" value="${state.plan[day]?.workout || ''}">
          <div class="check">
            <input type="checkbox" ${state.plan[day]?.go ? 'checked':''} id="go-${day}">
            <label for="go-${day}">Voy</label>
          </div>
        `;
        el.dow.appendChild(wrap);
      });
    }

    function shiftMonth(delta){
      const d = state.current;
      state.current = new Date(d.getFullYear(), d.getMonth()+delta, 1);
      renderCalendar();
    }

    function renderCalendar(){
      const d = state.current;
      const y = d.getFullYear();
      const m = d.getMonth();
      const first = new Date(y,m,1);
      const start = (first.getDay()+6)%7; // Monday=0
      const daysInMonth = new Date(y, m+1, 0).getDate();

      // Label
      const label = new Intl.DateTimeFormat('es-ES', { month:'long', year:'numeric' }).format(d);
      el.monthLabel.textContent = label.charAt(0).toUpperCase() + label.slice(1);

      // Days grid
      el.days.innerHTML = '';
      // leading blanks
      for(let i=0;i<start;i++){
        const blank = document.createElement('div');
        blank.className = 'day';
        blank.style.visibility = 'hidden';
        el.days.appendChild(blank);
      }

      const monthData = getMonthData();

      for(let day=1; day<=daysInMonth; day++){
        const dateObj = new Date(y,m,day);
        const dow = DOW[(dateObj.getDay()+6)%7]; // map Monday..Sunday
        const plan = state.plan[dow] || { go:false, workout:'' };
        const key = String(day);
        const saved = monthData[key] || { done:false, notes:'' };

        const cell = document.createElement('div');
        cell.className = 'day' + (plan.go ? '' : ' rest') + (saved.done ? ' done' : '');
        cell.innerHTML = `
          <div class="num">${day}</div>
          <div class="workout">${plan.go ? plan.workout : 'Descanso'}</div>
          <div class="done">✓ hecho</div>
          ${plan.go ? '<textarea placeholder="Notas (series, sensaciones, peso)"></textarea>' : ''}
        `;
        if(plan.go){
          const ta = cell.querySelector('textarea');
          ta.value = saved.notes || '';
          ta.oninput = () => {
            monthData[key] = { ...monthData[key], notes: ta.value, done: monthData[key]?.done || false };
            saveMonthData({ [key]: monthData[key] });
          };
        }
        cell.onclick = (e) => {
          if(e.target.tagName.toLowerCase()==='textarea') return;
          if(!plan.go) return; // ignore rest days toggle
          const curr = monthData[key] || { done:false, notes:'' };
          curr.done = !curr.done;
          monthData[key] = curr;
          saveMonthData({ [key]: curr });
          cell.classList.toggle('done', curr.done);
        };
        el.days.appendChild(cell);
      }
    }

    // ICS Export
    function exportICS(){
      const y = state.current.getFullYear();
      const m = state.current.getMonth();
      const daysInMonth = new Date(y, m+1, 0).getDate();
      const lines = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//Gym Planner//ES',
        'CALSCALE:GREGORIAN'
      ];

      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Madrid';
      const monthData = getMonthData();

      for(let day=1; day<=daysInMonth; day++){
        const d = new Date(y,m,day);
        const dow = DOW[(d.getDay()+6)%7];
        const plan = state.plan[dow] || { go:false, workout:'' };
        if(!plan.go) continue;
        const title = plan.workout || 'Entrenamiento';
        const dtStart = formatICSDate(d);
        const dtEnd = formatICSDate(new Date(y,m,day+1));
        const uid = `gym-${y}${String(m+1).padStart(2,'0')}${String(day).padStart(2,'0')}@local`;
        const note = (monthData[String(day)]?.notes || '').replace(/[

]/g,'\n');

        lines.push(
          'BEGIN:VEVENT',
          `UID:${uid}`,
          `SUMMARY:${escapeICS(title)}`,
          `DESCRIPTION:${escapeICS(note)}`,
          `DTSTART;VALUE=DATE:${dtStart}`,
          `DTEND;VALUE=DATE:${dtEnd}`,
          `X-TIMEZONE:${tz}`,
          'END:VEVENT'
        );
      }

      lines.push('END:VCALENDAR');
      const blob = new Blob([lines.join('
')], { type: 'text/calendar;charset=utf-8' });
      downloadBlob(blob, `gym-${monthKey()}.ics`);
    }

    // Data Export/Import for multi-device use
    function exportData(){
      const dump = {
        version: 1,
        exportedAt: new Date().toISOString(),
        duration: state.duration,
        plan: state.plan,
        months: collectAllMonths()
      };
      const blob = new Blob([JSON.stringify(dump, null, 2)], { type: 'application/json;charset=utf-8' });
      downloadBlob(blob, 'gym-datos.json');
    }

    function importData(evt){
      const file = evt.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if(!data || typeof data !== 'object') throw new Error('Formato no válido');
          if(data.plan) localStorage.setItem(STORAGE_KEYS.plan, JSON.stringify(data.plan));
          if(Number.isFinite(data.duration)) localStorage.setItem('gym.duration', String(data.duration));
          if(data.months && typeof data.months === 'object'){
            // clear existing months? no, just merge; but override conflicts
            Object.entries(data.months).forEach(([k,v]) => {
              localStorage.setItem(STORAGE_KEYS.monthDataPrefix + k, JSON.stringify(v||{}));
            });
          }
          // reload state
          state.plan = loadPlan();
          state.duration = Number(localStorage.getItem('gym.duration')||60);
          el.duracion.value = state.duration;
          buildDowConfig();
          renderCalendar();
          alert('Datos importados correctamente.');
        } catch(err){
          alert('No se pudieron importar los datos: ' + (err?.message || 'error desconocido'));
        } finally {
          evt.target.value = '';
        }
      };
      reader.readAsText(file);
    }

    function collectAllMonths(){
      const months = {};
      for(let i=0; i<localStorage.length; i++){
        const key = localStorage.key(i);
        if(key && key.startsWith(STORAGE_KEYS.monthDataPrefix)){
          const mk = key.substring(STORAGE_KEYS.monthDataPrefix.length);
          try { months[mk] = JSON.parse(localStorage.getItem(key)) || {}; } catch { months[mk] = {}; }
        }
      }
      // ensure current month present
      const curKey = monthKey();
      if(!months[curKey]) months[curKey] = getMonthData();
      return months;
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      URL.revokeObjectURL(url); a.remove();
    }

    function formatICSDate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}${m}${day}`;
    }
    function escapeICS(str){
      return String(str||'').replace(/[,;]/g, m => m===',' ? '\,' : '\;');
    }

    // ===== GitHub Gist Sync =====
    function requireToken(){
      const token = (el.gistToken.value || '').trim();
      if(!token) { alert('Introduce tu GitHub Token (scope: gist)'); throw new Error('no token'); }
      return token;
    }
    function headersJSON(token){
      return { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token, 'Accept':'application/vnd.github+json' };
    }

    async function createGist(){
      try{
        const token = requireToken();
        const body = {
          description: 'Datos calendario gym (sincronización)',
          public: false,
          files: { 'gym-datos.json': { content: JSON.stringify({ info:'inicial' }, null, 2) } }
        };
        const res = await fetch('https://api.github.com/gists', { method:'POST', headers: headersJSON(token), body: JSON.stringify(body) });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        const id = data.id;
        el.gistId.value = id;
        localStorage.setItem('gym.gist.id', id);
        alert('Gist creado: ' + id);
      } catch(e){ alert('No se pudo crear el Gist: ' + e.message); }
    }

    function buildDump(){
      return {
        version: 1,
        exportedAt: new Date().toISOString(),
        duration: state.duration,
        plan: state.plan,
        months: collectAllMonths()
      };
    }

    async function uploadToGist(){
      try{
        const token = requireToken();
        const id = (el.gistId.value||'').trim();
        if(!id) { alert('Pon el Gist ID o crea uno nuevo.'); return; }
        const files = { 'gym-datos.json': { content: JSON.stringify(buildDump(), null, 2) } };
        const res = await fetch('https://api.github.com/gists/' + id, { method:'PATCH', headers: headersJSON(token), body: JSON.stringify({ files }) });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        alert('Datos subidos al Gist.');
      } catch(e){ alert('Error al subir: ' + e.message); }
    }

    async function downloadFromGist(){
      try{
        const token = requireToken();
        const id = (el.gistId.value||'').trim();
        if(!id) { alert('Pon el Gist ID.'); return; }
        const res = await fetch('https://api.github.com/gists/' + id, { headers: headersJSON(token) });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        const file = data.files && data.files['gym-datos.json'];
        if(!file || !file.content) throw new Error('No se encontró gym-datos.json en el Gist');
        const parsed = JSON.parse(file.content);
        if(parsed.plan) localStorage.setItem(STORAGE_KEYS.plan, JSON.stringify(parsed.plan));
        if(Number.isFinite(parsed.duration)) localStorage.setItem('gym.duration', String(parsed.duration));
        if(parsed.months && typeof parsed.months === 'object'){
          Object.entries(parsed.months).forEach(([k,v]) => {
            localStorage.setItem(STORAGE_KEYS.monthDataPrefix + k, JSON.stringify(v||{}));
          });
        }
        state.plan = loadPlan();
        state.duration = Number(localStorage.getItem('gym.duration')||60);
        el.duracion.value = state.duration;
        buildDowConfig();
        renderCalendar();
        alert('Datos descargados del Gist.');
      } catch(e){ alert('Error al bajar: ' + e.message); }
    }(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}${m}${day}`;
    }
    function escapeICS(str){
      return String(str||'').replace(/[,;]/g, m => m===',' ? '\\,' : '\\;');
    }

    // Start
    init();
  </script>
</body>
</html>
