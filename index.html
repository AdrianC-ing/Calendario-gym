<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Calendario — Notas y tipos de entrenamiento</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --card:#0b1324; --line:#1f2937;
      --text:#e5e7eb; --muted:#94a3b8;
      --today-bg:#0d2b1c; --today-border:#22c55e;
      --weekend-bg:#12203a;
      --push:#60a5fa; --pull:#f472b6; --legs:#f59e0b;
      --selected:#38bdf8;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Arial, Helvetica, sans-serif; background:var(--bg); color:var(--text);}
    .wrap{max-width:980px; margin:24px auto; padding:0 16px;}
    header{display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; gap:8px;}
    h1{font-size:20px; margin:0; text-align:center; flex:1;}
    .nav{display:flex; gap:8px; align-items:center;}
    .btn{background:#0b1324; border:1px solid var(--line); color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:600;}
    .btn:hover{filter:brightness(1.1)}
    .btn.small{padding:6px 10px}
    .panel{background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:16px; overflow-x:hidden;} /* evita scroll horizontal fantasma */

    /* --- CALENDARIO --- */
    .cal-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
    #head, #days{
      display:grid;
      grid-template-columns: repeat(7, minmax(0, 1fr)); /* clave para que SIEMPRE encaje en móvil */
      gap:8px;
      width:100%;
    }
    .dow{ text-align:center; color:var(--muted); font-weight:700; font-size:12px; letter-spacing:.5px; text-transform:uppercase; min-width:0; }
    .day{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:8px; min-height:110px; display:flex; flex-direction:column; gap:6px; transition:background .15s ease, border-color .15s ease, box-shadow .15s ease; min-width:0;}
    .day.weekend{ background: var(--weekend-bg); }
    .day.is-today{ background:var(--today-bg); border-color:var(--today-border); box-shadow:0 0 0 1px var(--today-border) inset; }
    .day.is-selected{ border-color: var(--selected); box-shadow: 0 0 0 1px var(--selected) inset; }
    .num{font-size:12px; color:var(--muted);}
    .type-badge{font-size:12px; font-weight:700; width:max-content; padding:4px 8px; border-radius:999px; border:1px solid #334155;}
    .type-badge.push{ color:#03213e; background:color-mix(in srgb, var(--push) 30%, transparent); border-color: var(--push); }
    .type-badge.pull{ color:#3b0b26; background:color-mix(in srgb, var(--pull) 30%, transparent); border-color: var(--pull); }
    .type-badge.legs{ color:#3a2401; background:color-mix(in srgb, var(--legs) 30%, transparent); border-color: var(--legs); }
    .note-preview{font-size:13px; line-height:1.3; white-space:pre-wrap; word-break:break-word;}
    .edit{margin-top:auto; font-size:13px; color:var(--muted); cursor:pointer; align-self:flex-end; user-select:none; padding:4px 6px; border-radius:8px;}
    .edit:hover{background:#0a1325}
    .textarea{width:100%; min-height:70px; resize:vertical; border-radius:8px; border:1px solid var(--line); background:#0a1325; color:#fff; padding:8px; font-size:14px;}
    .hidden{display:none;}
    .help{color:var(--muted); font-size:13px; margin-top:8px}
    .error{margin-top:12px; padding:10px; border-radius:10px; background:#2a0f10; border:1px solid #5c1b1e; color:#ffb4b8; font-size:13px; white-space:pre-wrap;}

    /* Tipos */
    .types { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin: 8px 0 16px; }
    .type-card { cursor:pointer; user-select:none; border-radius:12px; border:1px solid var(--line); padding:10px 14px; font-weight:700; background:#0b1324; }
    .type-card:hover { filter: brightness(1.06); }
    .type-card.push { outline: 2px solid color-mix(in srgb, var(--push) 45%, transparent); }
    .type-card.pull { outline: 2px solid color-mix(in srgb, var(--pull) 45%, transparent); }
    .type-card.legs { outline: 2px solid color-mix(in srgb, var(--legs) 45%, transparent); }
    .type-card.none { outline: 2px dashed #334155; color: var(--muted); }
    .types .hint { color: var(--muted); font-size: 13px; }

    /* Resumen mensual */
    .summary { display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; margin-bottom:12px; }
    .sum-card { background:#0b1324; border:1px solid var(--line); border-radius:12px; padding:10px; }
    .sum-title { font-size:12px; color:var(--muted); margin:0 0 4px; text-transform:uppercase; letter-spacing:.5px; }
    .sum-value { font-size:20px; font-weight:800; margin:0; }
    .sum-push .sum-value { color: var(--push); }
    .sum-pull .sum-value { color: var(--pull); }
    .sum-legs .sum-value { color: var(--legs); }

    /* Móvil */
    @media (max-width: 600px) {
      .wrap{ margin: 12px auto; padding: 0 10px; }
      h1{ font-size: 18px; }
      /* el header de días queda pegado arriba si scroll vertical */
      #head { position: sticky; top: 0; z-index: 2; background: #111827; padding-bottom: 6px; }
      .day{ min-height: 90px; padding: 6px; }
      .num{ font-size: 11px; }
      .note-preview{ font-size: 13px; }
      .textarea{ min-height: 90px; font-size: 16px; }
      .panel{ border-radius: 12px; }
      .nav .btn.small{ padding:6px 8px }
      .type-card{ padding:8px 12px; }
      .summary { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="nav">
        <button id="prev" class="btn small" aria-label="Mes anterior">◀</button>
      </div>
      <h1 id="label">Mes YYYY</h1>
      <div class="nav">
        <button id="today" class="btn small" aria-label="Ir a hoy">Hoy</button>
        <button id="next" class="btn small" aria-label="Mes siguiente">▶</button>
      </div>
    </header>

    <div class="panel">
      <!-- Resumen mensual -->
      <div class="summary">
        <div class="sum-card sum-total">
          <p class="sum-title">Entrenados</p>
          <p class="sum-value" id="sumTotal">0</p>
        </div>
        <div class="sum-card sum-push">
          <p class="sum-title">Push</p>
          <p class="sum-value" id="sumPush">0</p>
        </div>
        <div class="sum-card sum-pull">
          <p class="sum-title">Pull</p>
          <p class="sum-value" id="sumPull">0</p>
        </div>
        <div class="sum-card sum-legs">
          <p class="sum-title">Legs</p>
          <p class="sum-value" id="sumLegs">0</p>
        </div>
      </div>

      <!-- Tipos -->
      <div class="types">
        <div class="type-card push" data-type="push">Push</div>
        <div class="type-card pull" data-type="pull">Pull</div>
        <div class="type-card legs" data-type="legs">Legs</div>
        <div class="type-card none" data-type="none">Quitar tipo</div>
        <span class="hint">Selecciona un día y luego el tipo.</span>
      </div>

      <!-- Calendario (con envoltorio para alineación perfecta en móvil) -->
      <div class="cal-wrap">
        <div class="grid" id="head"></div>
        <div class="grid" id="days"></div>
      </div>

      <p class="help">Toca “Editar” para escribir qué hiciste ese día. Se guarda automáticamente por mes en este dispositivo. (Opcional: usa la sincronización para tenerlo en varios dispositivos.)</p>
      <div id="err" class="error hidden"></div>

      <!-- Sincronización (opcional) -->
      <div class="sync">
        <label><strong>Sincronización (opcional) — GitHub Gist</strong> · Crea un token con <code>scope: gist</code> y úsalo para subir/bajar tus datos entre dispositivos.</label>
        <div class="row">
          <input id="gistToken" type="password" placeholder="GitHub Token (ghp_...)" />
          <input id="gistId" type="text" placeholder="Gist ID (ej. a1b2c3...)" />
        </div>
        <div class="row">
          <button id="createGist" class="btn small">Crear Gist privado</button>
          <button id="gistUpload" class="btn small">Subir a Gist</button>
          <button id="gistDownload" class="btn small">Bajar de Gist</button>
        </div>
        <small class="help">El token y el ID se guardan solo en este navegador. Si pierdes el dispositivo, revoca el token en GitHub.</small>
      </div>
    </div>
  </div>

  <script>
    (function(){
      function showError(e){
        var box = document.getElementById('err');
        box.textContent = 'Error: ' + (e && e.message ? e.message : e);
        box.classList.remove('hidden');
      }

      try {
        var DOW = ["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"];
        var MONTHS = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];

        var today = new Date();
        var view = new Date(today.getFullYear(), today.getMonth(), 1);
        var selectedDay = null;
        var dayCells = {};

        var el = {
          head: document.getElementById('head'),
          days: document.getElementById('days'),
          label: document.getElementById('label'),
          prev: document.getElementById('prev'),
          next: document.getElementById('next'),
          today: document.getElementById('today'),
          sumTotal: document.getElementById('sumTotal'),
          sumPush: document.getElementById('sumPush'),
          sumPull: document.getElementById('sumPull'),
          sumLegs: document.getElementById('sumLegs'),
          gistToken: document.getElementById('gistToken'),
          gistId: document.getElementById('gistId'),
          createGist: document.getElementById('createGist'),
          gistUpload: document.getElementById('gistUpload'),
          gistDownload: document.getElementById('gistDownload'),
        };

        function buildHead(){
          el.head.innerHTML = '';
          for (var i=0; i<7; i++){
            var div = document.createElement('div');
            div.className = 'dow';
            div.textContent = DOW[i];
            el.head.appendChild(div);
          }
        }

        function pad2(n){ return (n<10 ? '0' : '') + n; }
        function monthKey(d){ return d.getFullYear() + '-' + pad2(d.getMonth()+1); }

        // Storage helpers
        function normalizeDayEntry(v){
          if (v == null) return {note:'', type:''};
          if (typeof v === 'string') return {note: v, type:''};
          var note = (typeof v.note === 'string') ? v.note : '';
          var type = (typeof v.type === 'string') ? v.type : '';
          return {note: note, type: type};
        }
        function loadMonth(d){
          var key = 'cal.notes.' + monthKey(d || view);
          try {
            var raw = localStorage.getItem(key);
            var obj = raw ? JSON.parse(raw) : {};
            var out = {};
            for (var k in obj){ if (obj.hasOwnProperty(k)) out[k] = normalizeDayEntry(obj[k]); }
            return out;
          } catch(e){ return {}; }
        }
        function saveMonth(d, data){
          var key = 'cal.notes.' + monthKey(d || view);
          try { localStorage.setItem(key, JSON.stringify(data)); } catch(e){}
        }

        function setSelected(day){
          if (selectedDay && dayCells[selectedDay]) dayCells[selectedDay].classList.remove('is-selected');
          selectedDay = day;
          if (selectedDay && dayCells[selectedDay]) dayCells[selectedDay].classList.add('is-selected');
        }

        // Contadores por mes visible (solo días reales 1..n)
        function updateSummary(){
          var y = view.getFullYear(), m = view.getMonth();
          var dim = new Date(y, m + 1, 0).getDate();
          var data = loadMonth(view);
          var total=0, push=0, pull=0, legs=0;
          for (var day = 1; day <= dim; day++) {
            var entry = data[day];
            if (!entry || !entry.type) continue;
            total++;
            if (entry.type === 'push') push++;
            else if (entry.type === 'pull') pull++;
            else if (entry.type === 'legs') legs++;
          }
          el.sumTotal.textContent = String(total);
          el.sumPush.textContent = String(push);
          el.sumPull.textContent = String(pull);
          el.sumLegs.textContent = String(legs);
        }

        function render(){
          var y = view.getFullYear(), m = view.getMonth();
          var label = MONTHS[m] + ' ' + y;
          el.label.textContent = label.charAt(0).toUpperCase() + label.slice(1);

          el.days.innerHTML = '';
          dayCells = {};
          var first = new Date(y, m, 1);
          var start = (first.getDay()+6)%7;
          var dim = new Date(y, m+1, 0).getDate();
          var notes = loadMonth(view);

          // huecos iniciales
          for (var i=0;i<start;i++){
            var blank = document.createElement('div');
            blank.className = 'day';
            blank.style.visibility='hidden';
            el.days.appendChild(blank);
          }

          var todayCell = null;
          for (var d=1; d<=dim; d++){
            (function(day){
              var cell = document.createElement('div');
              cell.className = 'day';
              dayCells[day] = cell;

              var dow = new Date(y, m, day).getDay();
              if (dow === 6 || dow === 0) cell.classList.add('weekend');

              if (y === today.getFullYear() && m === today.getMonth() && day === today.getDate()){
                cell.classList.add('is-today'); todayCell = cell;
              }

              var entry = normalizeDayEntry(notes[day]);

              var num = document.createElement('div'); num.className = 'num'; num.textContent = day;
              var typeBadge = document.createElement('div');
              typeBadge.className = 'type-badge ' + (entry.type || '');
              typeBadge.textContent = entry.type ? entry.type.charAt(0).toUpperCase() + entry.type.slice(1) : '';
              if (!entry.type) typeBadge.classList.add('hidden');

              var prev = document.createElement('div'); prev.className='note-preview'; prev.textContent = entry.note || '';
              var edit = document.createElement('div'); edit.className='edit'; edit.textContent='Editar';
              var ta = document.createElement('textarea'); ta.className='textarea hidden'; ta.value = entry.note || '';

              cell.addEventListener('click', function(ev){
                var t = ev.target; if (t === ta || t === edit) return; setSelected(day);
              });
              edit.onclick = function(){ var opened=!ta.classList.contains('hidden'); ta.classList.toggle('hidden', opened); if(!opened){try{ta.focus();}catch(e){}} };
              ta.oninput = function(){ var month=loadMonth(view); var ent=normalizeDayEntry(month[day]); ent.note=ta.value.trim(); month[day]=ent; saveMonth(view, month); prev.textContent=ent.note; };

              cell.appendChild(num); cell.appendChild(typeBadge); cell.appendChild(prev); cell.appendChild(ta); cell.appendChild(edit);
              el.days.appendChild(cell);
            })(d);
          }

          setSelected(null);
          if (todayCell){ try{ todayCell.scrollIntoView({behavior:'smooth', block:'nearest', inline:'nearest'}); }catch(e){} }
          updateSummary();
        }

        // Navegación
        function shiftMonth(delta){ var y=view.getFullYear(), m=view.getMonth()+delta; view=new Date(y, m, 1); render(); }
        function goToday(){ view=new Date(today.getFullYear(), today.getMonth(), 1); render(); }
        el.prev.onclick = function(){ shiftMonth(-1); };
        el.next.onclick = function(){ shiftMonth(1); };
        el.today.onclick = function(){ goToday(); };
        document.addEventListener('keydown', function(ev){
          if (ev.key === 'ArrowLeft') shiftMonth(-1);
          else if (ev.key === 'ArrowRight') shiftMonth(1);
          else if (ev.key === 'Backspace') clearType();
          else if (ev.key.toLowerCase && ev.key.toLowerCase() === 'h') goToday();
        });

        // UI badge helper
        function updateBadgeUI(day, type){
          var cell = dayCells[day]; if (!cell) return;
          var badge = cell.querySelector('.type-badge');
          if (!badge){ badge=document.createElement('div'); badge.className='type-badge'; cell.insertBefore(badge, cell.children[1]); }
          if (!type || type === 'none'){ badge.textContent=''; badge.className='type-badge hidden'; return; }
          badge.className='type-badge ' + type; badge.textContent = type.charAt(0).toUpperCase() + type.slice(1); badge.classList.remove('hidden');
        }

        // Aplicar / quitar tipo
        function applyType(type){
          if (!selectedDay){ alert('Primero selecciona un día del calendario.'); return; }
          var month = loadMonth(view);
          var ent = normalizeDayEntry(month[selectedDay]);
          ent.type = (type === 'none') ? '' : type;
          month[selectedDay] = ent; saveMonth(view, month);
          updateBadgeUI(selectedDay, ent.type); updateSummary();
        }
        function clearType(){ applyType('none'); }

        var typeCards = document.querySelectorAll('.type-card');
        for (var i=0;i<typeCards.length;i++){ (function(card){ card.addEventListener('click', function(){ applyType(card.getAttribute('data-type')); }); })(typeCards[i]); }

        // ======= Sincronización con GitHub Gist (opcional) =======
        var TOKEN_KEY = 'cal.gist.token', GISTID_KEY = 'cal.gist.id';
        var tokenInput = document.getElementById('gistToken');
        var gistIdInput = document.getElementById('gistId');
        if (tokenInput) tokenInput.value = localStorage.getItem(TOKEN_KEY) || '';
        if (gistIdInput) gistIdInput.value = localStorage.getItem(GISTID_KEY) || '';
        if (tokenInput) tokenInput.onchange = function(){ localStorage.setItem(TOKEN_KEY, tokenInput.value.trim()); };
        if (gistIdInput) gistIdInput.onchange = function(){ localStorage.setItem(GISTID_KEY, gistIdInput.value.trim()); };

        function requireToken(){
          var t = (tokenInput && tokenInput.value || '').trim();
          if (!t){ alert('Introduce tu GitHub Token (scope: gist)'); throw new Error('no token'); }
          return t;
        }
        function headersJSON(token){
          return { 'Content-Type':'application/json', 'Authorization':'Bearer '+token, 'Accept':'application/vnd.github+json' };
        }
        function collectAllMonths(){
          var months = {};
          for (var i=0;i<localStorage.length;i++){
            var key = localStorage.key(i);
            if (key && key.indexOf('cal.notes.') === 0){
              var mk = key.substring('cal.notes.'.length);
              try { months[mk] = JSON.parse(localStorage.getItem(key)) || {}; } catch(e){ months[mk] = {}; }
            }
          }
          var cur = monthKey(view);
          if (!months[cur]) months[cur] = loadMonth(view);
          return months;
        }
        function buildDump(){ return { version:1, exportedAt:new Date().toISOString(), months: collectAllMonths() }; }

        async function createGist(){
          try{
            var token = requireToken();
            var body = { description:'Datos calendario gym (sincronización)', public:false, files:{ 'gym-datos.json': { content: JSON.stringify({info:'inicio'}, null, 2) } } };
            var res = await fetch('https://api.github.com/gists', { method:'POST', headers: headersJSON(token), body: JSON.stringify(body) });
            if (!res.ok) throw new Error('HTTP '+res.status);
            var data = await res.json(); var id = data.id;
            gistIdInput.value = id; localStorage.setItem(GISTID_KEY, id);
            alert('Gist creado: ' + id);
          } catch(e){ alert('No se pudo crear el Gist: ' + (e && e.message ? e.message : e)); }
        }
        async function uploadToGist(){
          try{
            var token = requireToken();
            var id = (gistIdInput && gistIdInput.value || '').trim();
            if (!id){ alert('Pon el Gist ID o crea uno nuevo.'); return; }
            var files = { 'gym-datos.json': { content: JSON.stringify(buildDump(), null, 2) } };
            var res = await fetch('https://api.github.com/gists/' + id, { method:'PATCH', headers: headersJSON(token), body: JSON.stringify({ files: files }) });
            if (!res.ok) throw new Error('HTTP '+res.status);
            alert('Datos subidos al Gist.');
          } catch(e){ alert('Error al subir: ' + (e && e.message ? e.message : e)); }
        }
        async function downloadFromGist(){
          try{
            var token = requireToken();
            var id = (gistIdInput && gistIdInput.value || '').trim();
            if (!id){ alert('Pon el Gist ID.'); return; }
            var res = await fetch('https://api.github.com/gists/' + id, { headers: headersJSON(token) });
            if (!res.ok) throw new Error('HTTP '+res.status);
            var data = await res.json();
            var file = data.files && data.files['gym-datos.json'];
            if (!file || !file.content) throw new Error('No se encontró gym-datos.json en el Gist');

            var parsed = JSON.parse(file.content);
            if (parsed && parsed.months && typeof parsed.months === 'object'){
              for (var k in parsed.months){
                localStorage.setItem('cal.notes.' + k, JSON.stringify(parsed.months[k] || {}));
              }
            }
            render();
            alert('Datos descargados del Gist.');
          } catch(e){ alert('Error al bajar: ' + (e && e.message ? e.message : e)); }
        }

        if (el.createGist) el.createGist.onclick = createGist;
        if (el.gistUpload) el.gistUpload.onclick = uploadToGist;
        if (el.gistDownload) el.gistDownload.onclick = downloadFromGist;

        // init
        buildHead();
        goToday();

      } catch(e){
        try { console.error(e); } catch(_) {}
        showError(e);
      }
    })();
  </script>
</body>
</html>
